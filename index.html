<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <title>AIS-kartta (Digitraffic + Leaflet)</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body>
<div id="map"></div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  const DIGITRAFFIC_USER = "JuhaMatti/LeafletAISDemo 1.0";

  const map = L.map("map").setView([60.2, 22.0], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
  }).addTo(map);

  let vesselLayer = null;

  async function loadAis() {
    const sixHoursMs = 6 * 60 * 60 * 1000;
    const from = Date.now() - sixHoursMs;
    const url = "https://meri.digitraffic.fi/api/ais/v1/locations?from=" + from;

    try {
      const res = await fetch(url, {
        headers: {
          "Digitraffic-User": DIGITRAFFIC_USER,
          "Accept": "application/json"
        }
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      if (vesselLayer) vesselLayer.remove();
      vesselLayer = L.geoJSON(data, {
        pointToLayer: (feature, latlng) =>
          L.circleMarker(latlng, { radius: 4, weight: 1, opacity: 1, fillOpacity: 0.8 })
      }).addTo(map);

      const bounds = vesselLayer.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
    } catch (e) {
      console.error("AIS-haku epäonnistui:", e);
    }
  }

  loadAis();
  // setInterval(loadAis, 2 * 60 * 1000); // jos haluat päivittyvän kartan
</script>
</body>
</html>
